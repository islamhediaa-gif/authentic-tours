import{c as k,r as h,j as t,S as B,X as V,b as G,o as O,y as F,h as U,a1 as X}from"./index-CnE16RuQ-v301.js";import{aR as H,aS as J,aU as Q,aT as W}from"./AreaChart-BNw5BYmj-v301.js";const Y=[["path",{d:"M12 8V4H8",key:"hb8ula"}],["rect",{width:"16",height:"12",x:"4",y:"8",rx:"2",key:"enze0r"}],["path",{d:"M2 14h2",key:"vft8re"}],["path",{d:"M20 14h2",key:"4cs60a"}],["path",{d:"M15 13v2",key:"1xurst"}],["path",{d:"M9 13v2",key:"rq6x2g"}]],D=k("bot",Y);const Z=[["path",{d:"m14 10 7-7",key:"oa77jy"}],["path",{d:"M20 10h-6V4",key:"mjg0md"}],["path",{d:"m3 21 7-7",key:"tjx5ai"}],["path",{d:"M4 14h6v6",key:"rmj7iw"}]],ee=k("minimize-2",Z);const te=[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}],["path",{d:"M9 3v18",key:"fh3hqa"}]],ae=k("panel-left",te);const se=[["path",{d:"M14.536 21.686a.5.5 0 0 0 .937-.024l6.5-19a.496.496 0 0 0-.635-.635l-19 6.5a.5.5 0 0 0-.024.937l7.93 3.18a2 2 0 0 1 1.112 1.11z",key:"1ffxy3"}],["path",{d:"m21.854 2.147-10.94 10.939",key:"12cjpa"}]],ne=k("send",se),ie=({data:f})=>t.jsx("div",{className:"h-24 w-full mt-3 bg-slate-50 rounded-xl p-2 border border-slate-100",children:t.jsx(H,{width:"100%",height:"100%",children:t.jsxs(J,{data:f,children:[t.jsx("defs",{children:t.jsxs("linearGradient",{id:"colorVal",x1:"0",y1:"0",x2:"0",y2:"1",children:[t.jsx("stop",{offset:"5%",stopColor:"#4f46e5",stopOpacity:.3}),t.jsx("stop",{offset:"95%",stopColor:"#4f46e5",stopOpacity:0})]})}),t.jsx(Q,{type:"monotone",dataKey:"value",stroke:"#4f46e5",fillOpacity:1,fill:"url(#colorVal)",strokeWidth:2}),t.jsx(W,{content:({active:C,payload:x})=>C&&x&&x.length?t.jsx("div",{className:"bg-slate-900 text-white text-[10px] px-2 py-1 rounded shadow-xl font-bold",children:x[0].value.toLocaleString()}):null})]})})}),de=({customers:f,suppliers:C,treasuries:x,transactions:b,employees:S,partners:re,settings:d,isOpen:I,onClose:E})=>{const[A,m]=h.useState([{role:"assistant",content:"مرحباً بك في نِبـراس إكس. أنا مساعدك الذكي المتكامل. يمكنني مساعدتك في تحليل بياناتك المالية أو الإجابة على أي سؤال يدور في ذهنك، تماماً مثل ChatGPT و Gemini. كيف يمكنني مساعدتك اليوم؟"}]),[j,L]=h.useState(""),[N,p]=h.useState(!1),[w,P]=h.useState(!1),$=h.useRef(null);h.useEffect(()=>{d.geminiApiKey&&m(n=>n.length===1&&n[0].role==="assistant"?[{role:"assistant",content:'نظام "نِبـراس إكس" مفعل الآن ومربوط بمحرك Gemini. كيف يمكنني مساعدتك اليوم؟'}]:n)},[d.geminiApiKey]),h.useEffect(()=>{$.current&&($.current.scrollTop=$.current.scrollHeight)},[A,N]);const R=async()=>{if(!j.trim()||N)return;const n=j.trim();L(""),m(u=>[...u,{role:"user",content:n}]),p(!0);try{const u=x.filter(e=>e.type==="CASH").reduce((e,s)=>e+Number(s.balance||0),0),g=x.filter(e=>e.type==="BANK").reduce((e,s)=>e+Number(s.balance||0),0),_=f.reduce((e,s)=>e+Number(s.balance||0),0),z=C.reduce((e,s)=>e+Number(s.balance||0),0),a={totalCash:u,totalBank:g,totalLiquidity:u+g,totalDebt:_,totalLiabilities:z,netBalance:u+g-z,totalRevenue:(b||[]).filter(e=>e&&!e.isVoided&&e.type==="INCOME").reduce((e,s)=>e+Number(s.amountInBase||0),0),totalExpenses:(b||[]).filter(e=>e&&!e.isVoided&&e.type==="EXPENSE").reduce((e,s)=>e+Number(s.amountInBase||0),0),activeTransactions:(b||[]).length,topCustomer:[...f].sort((e,s)=>Number(s.balance||0)-Number(e.balance||0))[0],employeesCount:S.length,totalCommissions:(b||[]).reduce((e,s)=>{if(!s||s.isVoided)return e;const i=Number(s.sellingPrice||0),o=Number(s.employeeCommissionRate||0)*.01;return e+i*o},0),baseCurrency:d.baseCurrency,companyName:d.name},K=e=>{const s=e.toLowerCase();if(s.includes("اهلا")||s.includes("أهلاً")||s.includes("سلام")||s.includes("مرحبا")||s.includes("صباح")||s.includes("مساء"))return{content:`أهلاً بك! أنا "نِبـراس إكس"، مساعدك الذكي. كيف يمكنني مساعدتك اليوم في إدارة نظام ${a.companyName}؟

يمكنك سؤالي عن الأرباح، مديونيات العملاء، أو طلب تحليل مالي شامل.`};if(e.includes("مكسب")||e.includes("خسارة")||e.includes("ربح")||e.includes("أرباح")||e.includes("مصاريف")||e.includes("مبيعات")||e.includes("أداء مال")){const i=a.totalRevenue-a.totalExpenses;return{content:`التحليل المالي للأرباح والخسائر:
• إجمالي الإيرادات (المبيعات): ${a.totalRevenue.toLocaleString()} ${a.baseCurrency}
• إجمالي المصاريف والأعباء: ${a.totalExpenses.toLocaleString()} ${a.baseCurrency}
• صافي الربح التشغيلي: ${i.toLocaleString()} ${a.baseCurrency}
• نسبة الربحية: ${a.totalRevenue>0?Number(Number(i)/Number(a.totalRevenue)*100).toFixed(1):0}%

الموقف الحالي يعتبر ${i>0?"إيجابياً":"يحتاج لمراجعة التكاليف"} بناءً على العمليات المسجلة.`}}if(e.includes("عميل")||e.includes("مديونية")||e.includes("ديون")||e.includes("فلوس بره")){const i=[...f].filter(r=>Number(r.balance||0)>0).sort((r,c)=>Number(c.balance||0)-Number(r.balance||0)).slice(0,3);if(i.length===0)return{content:"لا يوجد عملاء لديهم مديونيات حالياً. جميع الحسابات متزنة أو دائنة."};let o=`تحليل مديونيات العملاء:
إجمالي الديون المستحقة لك عند العملاء: ${a.totalDebt.toLocaleString()} ${a.baseCurrency}

أعلى 3 عملاء مديونية:
`;return i.forEach((r,c)=>{o+=`${c+1}. ${r.name}: بقيمة ${Number(r.balance).toLocaleString()} ${a.baseCurrency}
`}),o+=`
نصيحة: المديونيات تمثل ${Number(Number(a.totalDebt)/(Number(a.totalLiquidity)||1)*100).toFixed(1)}% من سيولتك الحالية.`,{content:o}}if(e.includes("عمول")||e.includes("موظف")){const i=S.find(o=>e.includes(o.name));if(i){const o=(b||[]).filter(r=>r&&!r.isVoided&&r.employeeId===i.id).reduce((r,c)=>r+Number(c.sellingPrice||0)*Number(c.employeeCommissionRate||0)*.01,0);return{content:`تحليل أداء الموظف: ${i.name}
• الرصيد الحالي: ${Number(i.balance).toLocaleString()} ${a.baseCurrency}
• العمولات المستحقة: ${o.toLocaleString()} ${a.baseCurrency}
• معدل العمولة: ${Number(i.commissionRate)}%`}}return{content:`إجمالي العمولات التشغيلية لـ ${a.employeesCount} موظف هي ${a.totalCommissions.toLocaleString()} ${a.baseCurrency}.`}}if(e.includes("حلل")||e.includes("وضع")||e.includes("تقرير")||e.includes("فلوس")||e.includes("حساب")||e.includes("تحليل")||e.includes("موقف")){const i=Array.from({length:7}).map((o,r)=>({name:r,value:(b||[]).slice(r*5,(r+1)*5).reduce((c,v)=>c+Number(v&&v.sellingPrice||0),0)||Math.random()*5e3})).reverse();return{content:`تقرير الموقف المالي الشامل - ${a.companyName}:

• السيولة النقدية (خزائن): ${a.totalCash.toLocaleString()}
• السيولة البنكية: ${a.totalBank.toLocaleString()}
• إجمالي السيولة: ${a.totalLiquidity.toLocaleString()}

• مديونيات العملاء (لك): ${a.totalDebt.toLocaleString()}
• مستحقات الموردين (عليك): ${a.totalLiabilities.toLocaleString()}

• صافي الموقف المالي: ${(a.totalLiquidity-a.totalLiabilities).toLocaleString()}

الموقف الحالي: ${a.totalLiquidity>a.totalLiabilities?"لديك فائض سيولة جيد لتغطية الالتزامات.":"التزاماتك تتخطى السيولة النقدية المتوفرة حالياً."}`,chartData:i}}return{content:`أنا أراقب النظام حالياً. بخصوص "${e}"، الشركة لديها ${a.activeTransactions} عملية نشطة بسيولة ${a.totalCash.toLocaleString()} ${a.baseCurrency}. هل تحتاج لتحليل أعمق؟`}};if(d.geminiApiKey)try{const e=d.geminiApiKey.trim(),s=`أنت "نِبـراس إكس" (Nebras X)، الخبير المالي والذكي المدمج في نظام نِبـراس ERP. 
          مهمتك هي أن تكون المستشار المالي والتقني الأول للمستخدم، تحلل البيانات بذكاء، تقترح الحلول، وتجيب على أي استفسار بأسلوب احترافي جداً (مثل ChatGPT-4).
          
          لديك وصول كامل لملخص الموقف المالي الحالي:
          - الشركة: ${a.companyName}
          - العملة الأساسية: ${a.baseCurrency}
          - السيولة المتوفرة (كاش): ${a.totalCash}
          - السيولة في البنك: ${a.totalBank}
          - إجمالي السيولة الجاهزة: ${a.totalLiquidity}
          - مديونيات العملاء (فلوس بره): ${a.totalDebt}
          - مستحقات الموردين (التزامات): ${a.totalLiabilities}
          - صافي المركز المالي الحالي: ${a.netBalance}
          - أداء المبيعات (إيرادات): ${a.totalRevenue}
          - المصاريف الكلية: ${a.totalExpenses}
          - صافي الربح التقديري: ${a.totalRevenue-a.totalExpenses}
          - عدد العمليات المسجلة: ${a.activeTransactions}
          - عدد الموظفين: ${a.employeesCount}

          القواعد الذهبية:
          1. لا تكتفِ بسرد الأرقام، بل حللها (مثلاً: "لديك مديونيات تمثل 40% من رأس مالك، يفضل البدء في التحصيل").
          2. إذا كان صافي الربح سالباً أو السيولة ضعيفة، نبه المستخدم بذكاء.
          3. أجب على الأسئلة العامة (تاريخ، علوم، تقنية، طبخ) بذكاء بشري كامل ولا تحصر نفسك في المحاسبة فقط.
          4. استخدم أسلوباً مشجعاً ومهنياً.
          5. إذا سألك المستخدم "من أنت"، قل أنا "نِبـراس إكس" محرك الذكاء الاصطناعي لنظام نِبـراس.`,i=[{version:"v1",model:"gemini-1.5-flash"},{version:"v1beta",model:"gemini-1.5-flash"},{version:"v1",model:"gemini-1.5-flash-8b"},{version:"v1beta",model:"gemini-2.0-flash-exp"}];let o=null,r=!1,c=!1,v=!1;for(const y of i)try{const l=await fetch(`https://generativelanguage.googleapis.com/${y.version}/models/${y.model}:generateContent?key=${e}`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contents:[{parts:[{text:`${s}

سؤال المستخدم: ${n}`}]}]})});if(l.status===401||l.status===403){c=!0,o=await l.json();break}if(l.status===429){v=!0,o=await l.json();continue}if(l.ok){const T=(await l.json()).candidates?.[0]?.content?.parts?.[0]?.text;if(T){m(q=>[...q,{role:"assistant",content:T}]),p(!1),r=!0;break}}else o=await l.json(),console.warn(`Fallback: Model ${y.model} failed:`,o)}catch(l){o={error:{message:l instanceof Error?l.message:String(l)}}}if(r)return;if(c){m(y=>[...y,{role:"assistant",content:"خطأ في الصلاحيات: مفتاح الـ API غير صالح. يرجى مراجعة الإعدادات."}]),p(!1);return}console.warn("Gemini Failed or Quota Exceeded, falling back to search/local engine.")}catch(e){console.error("Critical AI Error:",e)}try{const e=await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(n)}&format=json&no_html=1&skip_disambig=1`);if(e.ok){const s=await e.json();if(s.AbstractText){m(i=>[...i,{role:"assistant",content:`${s.AbstractText}

(ملاحظة: هذه الإجابة عبر محرك البحث البديل لتعذر الوصول لمحرك Gemini حالياً)`}]),p(!1);return}}}catch{console.error("Search fallback failed")}const M=K(n);setTimeout(()=>{m(e=>[...e,{role:"assistant",content:`${M.content}

(المحرك الاحتياطي: نِبـراس إكس يعمل حالياً بالذكاء المحلي)`,chartData:M.chartData}]),p(!1)},600)}catch{m(g=>[...g,{role:"assistant",content:"حدث خطأ في معالجة البيانات."}]),p(!1)}};return I?t.jsxs("div",{className:`fixed transition-all duration-500 ease-in-out z-[100] flex flex-col bg-white border border-slate-200 shadow-2xl overflow-hidden
      ${w?"top-0 right-0 bottom-0 w-[450px] rounded-none":"bottom-8 right-8 w-[420px] h-[650px] rounded-[2rem]"}`,children:[t.jsxs("div",{className:"bg-slate-900 p-5 text-white flex items-center justify-between shrink-0",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx("div",{className:"w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center",children:t.jsx(D,{size:22})}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-bold text-sm tracking-tight",children:"نِبـراس إكس"}),t.jsxs("span",{className:`text-[10px] font-bold uppercase tracking-widest flex items-center gap-1.5 ${d.geminiApiKey?"text-emerald-400":"text-indigo-400"}`,children:[t.jsx("span",{className:`w-1.5 h-1.5 rounded-full animate-pulse ${d.geminiApiKey?"bg-emerald-400":"bg-indigo-400"}`}),d.geminiApiKey?"AI Engine Active":"Operational Intelligence"]})]})]}),t.jsxs("div",{className:"flex items-center gap-2",children:[t.jsx("button",{onClick:()=>P(!w),className:"w-8 h-8 hover:bg-white/10 rounded-lg flex items-center justify-center transition-colors text-slate-400",title:w?"تعويم":"تثبيت جانبي",children:w?t.jsx(ee,{size:16}):t.jsx(ae,{size:16})}),t.jsx("button",{onClick:E,className:"w-8 h-8 hover:bg-white/10 rounded-lg flex items-center justify-center transition-colors text-slate-400",children:t.jsx(V,{size:18})})]})]}),t.jsx("div",{className:"px-4 py-2 bg-slate-50 border-b border-slate-100 flex gap-2 overflow-x-auto no-scrollbar shrink-0",children:[{label:"تحليل سيولة",icon:t.jsx(G,{size:12}),cmd:"حلل الموقف المالي"},{label:"المديونيات",icon:t.jsx(O,{size:12}),cmd:"من هم العملاء الأكثر مديونية؟"},{label:"أداء الموظفين",icon:t.jsx(F,{size:12}),cmd:"تقرير عمولات الموظفين"}].map(n=>t.jsxs("button",{onClick:()=>L(n.cmd),className:"whitespace-nowrap px-3 py-1.5 bg-white border border-slate-200 rounded-lg text-[10px] font-bold text-slate-600 hover:border-indigo-500 hover:text-indigo-600 transition-all flex items-center gap-1.5 shadow-sm",children:[n.icon," ",n.label]},n.label))}),t.jsxs("div",{ref:$,className:"flex-1 overflow-y-auto p-5 space-y-5 bg-slate-50/50 custom-scrollbar",children:[A.map((n,u)=>t.jsx("div",{className:`flex ${n.role==="user"?"justify-end":"justify-start"}`,children:t.jsxs("div",{className:`flex gap-3 max-w-[90%] ${n.role==="user"?"flex-row-reverse":"flex-row"}`,children:[t.jsx("div",{className:`w-7 h-7 rounded-lg flex items-center justify-center shrink-0 mt-1 ${n.role==="user"?"bg-indigo-600 text-white":"bg-white shadow-sm border border-slate-200 text-indigo-600"}`,children:n.role==="user"?t.jsx(U,{size:14}):t.jsx(D,{size:14})}),t.jsxs("div",{className:`p-4 rounded-2xl text-[13px] font-medium leading-relaxed shadow-sm ${n.role==="user"?"bg-indigo-600 text-white rounded-tr-none":"bg-white text-slate-800 rounded-tl-none border border-slate-100"}`,children:[t.jsx("div",{className:"whitespace-pre-wrap",children:n.content}),n.chartData&&t.jsx(ie,{data:n.chartData})]})]})},u)),N&&t.jsxs("div",{className:"flex gap-3 items-center animate-pulse",children:[t.jsx("div",{className:"w-7 h-7 rounded-lg bg-white border border-slate-200 text-indigo-600 flex items-center justify-center",children:t.jsx(X,{size:14,className:"animate-spin"})}),t.jsx("div",{className:"text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:"Processing Data..."})]})]}),t.jsxs("div",{className:"p-5 bg-white border-t border-slate-100 shrink-0",children:[t.jsxs("div",{className:"relative group",children:[t.jsx("input",{type:"text",value:j,onChange:n=>L(n.target.value),onKeyDown:n=>n.key==="Enter"&&R(),placeholder:"اسأل نِبـراس إكس عن أي شيء...",className:"w-full pl-12 pr-5 py-3.5 bg-slate-50 border border-slate-200 focus:border-indigo-500 rounded-xl font-bold text-xs text-slate-900 outline-none transition-all focus:bg-white focus:shadow-inner"}),t.jsx("button",{onClick:R,disabled:!j.trim()||N,className:"absolute left-1.5 top-1.5 w-10 h-10 bg-indigo-600 text-white rounded-lg flex items-center justify-center hover:bg-indigo-700 transition-all disabled:opacity-30 shadow-lg shadow-indigo-200",children:t.jsx(ne,{size:16})})]}),t.jsxs("div",{className:"mt-3 flex items-center justify-between text-[8px] font-bold text-slate-400 uppercase tracking-widest px-1",children:[t.jsx("span",{children:"Nebras X Intelligence"}),t.jsx("span",{children:"v3.0.1 Premium"})]})]})]}):t.jsxs("button",{onClick:()=>E(),className:"fixed bottom-8 right-8 w-14 h-14 bg-indigo-600 text-white rounded-2xl shadow-[0_10px_30px_rgba(79,70,229,0.4)] flex items-center justify-center hover:scale-110 active:scale-95 transition-all z-[100] group",children:[t.jsx(B,{size:24}),t.jsx("div",{className:"absolute -top-1 -right-1 w-4 h-4 bg-emerald-500 rounded-full border-2 border-white"})]})};export{de as default};
