import{c as W,r as y,j as e,O as F,R as Q,w as Y,U as $,f as G}from"./index-DYzCRgaJ-v301.js";import{T as D}from"./triangle-alert-dD_r2uDF-v301.js";import{L as q}from"./landmark-mCwTSQ6x-v301.js";const H=[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"m12 16 4-4-4-4",key:"1i9zcv"}],["path",{d:"M8 12h8",key:"1wcyev"}]],K=W("circle-arrow-right",H),te=({customers:r,suppliers:o,treasuries:d,employees:h,partners:m,transactions:X,journalEntries:B,currencies:T,onClosingComplete:O,settings:w,currentUser:C})=>{const z=C?.permissions?.includes("HIDE_FINANCIAL_AMOUNTS"),_=C?.role==="BOOKING_EMPLOYEE",u=z||_,[U,M]=y.useState(!1),[P,I]=y.useState(1),[g,S]=y.useState("RETAINED"),[j,k]=y.useState({}),i=y.useMemo(()=>{const t={};(r||[]).forEach(l=>{l?.id&&(t[`CUSTOMER-${l.id}`]=l.openingBalanceInBase||0)}),(o||[]).forEach(l=>{l?.id&&(t[`SUPPLIER-${l.id}`]=l.openingBalanceInBase||0)}),(d||[]).forEach(l=>{l?.id&&(t[`TREASURY-${l.id}`]=l.openingBalance||0)}),(m||[]).forEach(l=>{l?.id&&(t[`PARTNER-${l.id}`]=l.openingBalance||0)}),(h||[]).forEach(l=>{l?.id&&(t[`LIABILITY-${l.id}`]=l.openingBalance||0,t[`EMPLOYEE_ADVANCE-${l.id}`]=l.openingAdvances||0)});let s=0,f=0;(B||[]).forEach(l=>{l&&l.lines&&(l.lines||[]).forEach(a=>{if(a&&a.accountId&&a.accountType){const v=`${a.accountType}-${a.accountId}`;t[v]===void 0&&(t[v]=0),["CUSTOMER","TREASURY","EMPLOYEE_ADVANCE","ASSET"].includes(a.accountType)?t[v]+=(a.debit||0)-(a.credit||0):["SUPPLIER","LIABILITY","PARTNER","EQUITY","REVENUE","EXPENSE"].includes(a.accountType)&&(t[v]+=(a.credit||0)-(a.debit||0)),a.accountType==="REVENUE"&&(s+=(a.credit||0)-(a.debit||0)),a.accountType==="EXPENSE"&&(f+=(a.debit||0)-(a.credit||0))}})});const x=(d||[]).reduce((l,a)=>l+(a&&t[`TREASURY-${a.id}`]||0),0)+(r||[]).reduce((l,a)=>l+(a&&t[`CUSTOMER-${a.id}`]||0),0)+(h||[]).reduce((l,a)=>l+(a&&t[`EMPLOYEE_ADVANCE-${a.id}`]||0),0),L=(o||[]).reduce((l,a)=>l+(a&&t[`SUPPLIER-${a.id}`]||0),0)+(h||[]).reduce((l,a)=>l+(a&&t[`LIABILITY-${a.id}`]||0),0)+(m||[]).reduce((l,a)=>l+(a&&t[`PARTNER-${a.id}`]||0),0);return{assets:x,liabilities:L,equity:x-L,netProfit:s-f,balances:t}},[r,o,d,h,m,B]),V=()=>{confirm(`⚠️ تنبيه هام جداً: هل أنت متأكد من إقفال السنة المالية؟ 

 سيتم ترحيل الأرصدة الحالية لتصبح أرصدة افتتاحية وسيتم تصفير سجل العمليات والقيود بالكامل لبدء سنة جديدة.`)&&(M(!0),setTimeout(()=>{const t=i.netProfit,s=i.balances,f=(r||[]).map(n=>{const b=((T||[]).find(E=>E?.code===n?.openingBalanceCurrency)||(T||[]).find(E=>E?.code===(w?.baseCurrency||"EGP"))||{rateToMain:1})?.rateToMain||1,N=s[`CUSTOMER-${n?.id}`]||0,A=N*(1/b);return{...n,openingBalance:A,openingBalanceInBase:N,balance:N,currencyBalance:A}}),x=(o||[]).map(n=>{const b=((T||[]).find(E=>E?.code===n?.openingBalanceCurrency)||(T||[]).find(E=>E?.code===(w?.baseCurrency||"EGP"))||{rateToMain:1})?.rateToMain||1,N=s[`SUPPLIER-${n?.id}`]||0,A=N*(1/b);return{...n,openingBalance:A,openingBalanceInBase:N,balance:N,currencyBalance:A}}),L=(d||[]).map(n=>{const c=s[`TREASURY-${n?.id}`]||0;return{...n,openingBalance:c,balance:c}}),l=(h||[]).map(n=>{const c=s[`LIABILITY-${n.id}`]||0,b=s[`EMPLOYEE_ADVANCE-${n.id}`]||0;return{...n,openingBalance:c,openingAdvances:b,balance:c,advances:b}});let a=(m||[]).map(n=>({...n,balance:s[`PARTNER-${n?.id}`]||0}));if(t!==0)if(g==="RETAINED"){const n=a.findIndex(c=>c?.id?.startsWith("P-RETAINED-")||c?.name==="أرباح مرحلة");n>-1?a[n]={...a[n],balance:(a[n].balance||0)+t}:a.push({id:`P-RETAINED-${Date.now()}`,name:"أرباح مرحلة",balance:t})}else if(g==="EQUALLY"){const n=a.filter(c=>!c?.id?.startsWith("P-RETAINED-"));if(n.length>0){const c=t/n.length;a=a.map(b=>b?.id?.startsWith("P-RETAINED-")?b:{...b,balance:(b?.balance||0)+c})}}else g==="MANUAL"&&(a=a.map(n=>({...n,balance:(n?.balance||0)+(j[n?.id||""]||0)})));const v=a.map(n=>({...n,openingBalance:n?.balance||0,balance:n?.balance||0}));O(f,x,L,l,v),M(!1),I(3)},2e3))};return e.jsx("div",{className:"max-w-4xl mx-auto py-10 px-4",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden",children:[e.jsxs("div",{className:"bg-slate-900 p-10 text-center relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-indigo-500 bg-opacity-5 blur-3xl rounded-full -mr-20 -mt-20 w-64 h-64"}),e.jsx("div",{className:"w-20 h-20 bg-indigo-500 bg-opacity-10 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-indigo-500 border-opacity-20 relative z-10",children:e.jsx(F,{size:40,className:"text-indigo-400"})}),e.jsx("h2",{className:"text-3xl font-bold text-white mb-2 relative z-10",children:"إقفال السنة المالية والترحيل"}),e.jsx("p",{className:"text-indigo-400 text-opacity-60 font-medium tracking-[0.2em] uppercase text-xs relative z-10",children:"نظام التحويل للأرصدة الافتتاحية الجديدة"})]}),P===1&&e.jsxs("div",{className:"p-10 space-y-8",children:[e.jsxs("div",{className:"bg-amber-50 border border-amber-200 p-6 rounded-2xl flex items-start gap-5",children:[e.jsx(D,{className:"text-amber-600 shrink-0",size:32}),e.jsxs("div",{className:"space-y-1",children:[e.jsx("h4",{className:"text-lg font-bold text-amber-900",children:"ماذا سيحدث عند الإقفال؟"}),e.jsxs("ul",{className:"list-disc list-inside text-amber-800 font-medium space-y-1 text-sm",children:[e.jsx("li",{children:'سيتم اعتماد الرصيد الحالي لكل عميل ومورد كـ "رصيد افتتاحي" للسنة الجديدة.'}),e.jsx("li",{children:"سيتم مسح سجل العمليات والقيود الحالية (يُنصح بتحميل نسخة احتياطية أولاً)."}),e.jsx("li",{children:"ستبدأ السنة المالية الجديدة بسجل نظيف تماماً مع الحفاظ على المديونيات."})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[e.jsx(p,{label:"إجمالي السيولة (الخزائن)",value:u?"****":((d||[]).reduce((t,s)=>t+(s&&i.balances[`TREASURY-${s.id}`]||0),0)||0).toLocaleString()||"0",color:"text-emerald-600"}),e.jsx(p,{label:"ديون العملاء (الأصول)",value:u?"****":((r||[]).reduce((t,s)=>t+(s&&i.balances[`CUSTOMER-${s.id}`]||0),0)||0).toLocaleString()||"0",color:"text-slate-700"}),e.jsx(p,{label:"مستحقات الموردين (الخصوم)",value:u?"****":((o||[]).reduce((t,s)=>t+(s&&i.balances[`SUPPLIER-${s.id}`]||0),0)||0).toLocaleString()||"0",color:"text-rose-500"}),e.jsx(p,{label:"مستحقات الموظفين",value:u?"****":((h||[]).reduce((t,s)=>t+(s&&i.balances[`LIABILITY-${s.id}`]||0),0)||0).toLocaleString()||"0",color:"text-rose-500"}),e.jsx(p,{label:"سلف الموظفين (أصول)",value:u?"****":((h||[]).reduce((t,s)=>t+(s&&i.balances[`EMPLOYEE_ADVANCE-${s.id}`]||0),0)||0).toLocaleString()||"0",color:"text-emerald-500"}),e.jsx(p,{label:"جاري الشركاء",value:u?"****":((m||[]).reduce((t,s)=>t+(s&&i.balances[`PARTNER-${s.id}`]||0),0)||0).toLocaleString()||"0",color:"text-slate-900"}),e.jsx(p,{label:"صافي الربح المستحق للترحيل",value:u?"****":(i.netProfit||0).toLocaleString()||"0",color:"text-amber-600"})]}),e.jsxs("div",{className:"bg-slate-50 p-8 rounded-3xl border border-slate-100 space-y-6",children:[e.jsxs("div",{children:[e.jsxs("h4",{className:"text-sm font-bold text-slate-900 mb-4 uppercase",children:["توزيع صافي الربح المستحق (",(i.netProfit||0).toLocaleString()||"0",")"]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsx("button",{onClick:()=>S("RETAINED"),className:`p-4 rounded-xl border font-bold text-sm transition-all ${g==="RETAINED"?"border-amber-500 bg-amber-50 text-amber-700":"border-slate-200 bg-white text-slate-400"}`,children:"ترحيل كأرباح مرحلة"}),e.jsx("button",{onClick:()=>{S("EQUALLY");const t=(m||[]).filter(x=>!x?.id?.startsWith("P-RETAINED-")),s=i.netProfit*(1/(t.length||1)),f={};(m||[]).forEach(x=>{x?.id&&(x.id.startsWith("P-RETAINED-")?f[x.id]=0:f[x.id]=s)}),k(f)},className:`p-4 rounded-xl border font-bold text-sm transition-all ${g==="EQUALLY"?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-slate-200 bg-white text-slate-400"}`,children:"توزيع بالتساوي على الشركاء"}),e.jsx("button",{onClick:()=>S("MANUAL"),className:`p-4 rounded-xl border font-bold text-sm transition-all ${g==="MANUAL"?"border-indigo-500 bg-indigo-50 text-indigo-700":"border-slate-200 bg-white text-slate-400"}`,children:"توزيع يدوي مخصص"})]})]}),g==="MANUAL"&&e.jsxs("div",{className:"space-y-3 bg-white p-5 rounded-2xl border border-slate-100",children:[(m||[]).map(t=>e.jsxs("div",{className:"flex justify-between items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-bold text-sm text-slate-700",children:t?.name||"---"}),t?.id?.startsWith("P-RETAINED-")&&e.jsx("span",{className:"bg-amber-50 text-amber-600 text-[8px] px-2 py-0.5 rounded-full font-bold uppercase",children:"حساب تجمعيعي"})]}),e.jsx("input",{type:"number",className:"p-2 bg-slate-50 rounded-lg border border-slate-200 w-32 text-center font-bold text-sm outline-none focus:border-indigo-500 transition-all",value:t?.id&&j[t.id]||0,onChange:s=>{t?.id&&k({...j,[t.id]:parseFloat(s.target.value||"0")})}})]},t?.id)),e.jsxs("div",{className:"pt-3 border-t flex justify-between font-bold text-sm text-slate-900",children:[e.jsx("span",{children:"إجمالي الموزع:"}),e.jsxs("span",{className:Object.values(j).reduce((t,s)=>t+s,0)===i.netProfit?"text-emerald-600":"text-rose-600",children:[(Object.values(j).reduce((t,s)=>t+s,0)||0).toLocaleString()||"0"," / ",(i.netProfit||0).toLocaleString()||"0"]})]})]}),e.jsxs("div",{className:"flex justify-between items-center pt-6 border-t border-slate-200",children:[e.jsx("span",{className:"text-xl font-bold text-slate-900 uppercase",children:"صافي المركز المالي للترحيل"}),e.jsxs("span",{className:"text-2xl font-bold text-amber-600",children:[u?"****":(i.equity||0).toLocaleString()||"0"," ج.م"]})]}),e.jsxs("button",{onClick:()=>{if(g==="MANUAL"&&Object.values(j).reduce((t,s)=>t+s,0)!==i.netProfit){alert("يجب أن يتساوى إجمالي الموزع يدوياً مع صافي الربح");return}I(2)},className:"w-full bg-slate-900 text-indigo-400 py-5 rounded-2xl font-bold text-lg shadow-lg hover:bg-indigo-500 hover:text-slate-900 transition-all active:scale-95 flex items-center justify-center gap-3",children:["مراجعة الأرصدة الافتتاحية ",e.jsx(K,{size:24})]})]})]}),P===2&&e.jsxs("div",{className:"p-10 space-y-8",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-xl font-bold text-slate-900",children:"مراجعة الأرصدة النهائية للترحيل"}),e.jsx("button",{onClick:()=>I(1),className:"text-slate-400 font-bold text-sm hover:text-slate-600 transition-all underline",children:"تعديل التوزيع"})]}),e.jsxs("div",{className:"bg-slate-50 rounded-2xl border border-slate-100 divide-y divide-slate-200",children:[e.jsxs("div",{className:"p-4 flex items-center justify-between text-[10px] font-bold text-slate-400 uppercase tracking-widest",children:[e.jsx("span",{children:"البند"}),e.jsx("span",{children:"الرصيد النهائي (الافتتاحي القادم)"})]}),e.jsx("div",{className:"max-h-96 overflow-y-auto",children:[...r.map(t=>({name:`عميل: ${t.name}`,val:i.balances[`CUSTOMER-${t.id}`]||0,color:"text-slate-700"})),...o.map(t=>({name:`مورد: ${t.company}`,val:i.balances[`SUPPLIER-${t.id}`]||0,color:"text-rose-500"})),...d.map(t=>({name:`خزينة: ${t.name}`,val:i.balances[`TREASURY-${t.id}`]||0,color:"text-emerald-600"})),...m.map(t=>({name:`شريك: ${t.name}`,val:(i.balances[`PARTNER-${t.id}`]||0)+(j[t.id]||0),color:"text-slate-900"}))].map((t,s)=>e.jsxs("div",{className:"p-4 flex items-center justify-between bg-white/50 hover:bg-white transition-all",children:[e.jsx("span",{className:"text-sm font-bold text-slate-600",children:t.name}),e.jsxs("span",{className:`text-sm font-bold tabular-nums ${t.color}`,children:[u?"****":t.val.toLocaleString()," ج.م"]})]},s))})]}),e.jsxs("div",{className:"p-8 bg-rose-50 border border-rose-100 rounded-3xl space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 bg-rose-100 rounded-full flex items-center justify-center",children:e.jsx(D,{className:"text-rose-600",size:24})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-lg font-bold text-rose-900",children:"تأكيد الإجراء النهائي"}),e.jsx("p",{className:"text-sm text-rose-700 font-medium",children:"هذا الإجراء لا يمكن التراجع عنه. سيتم تصفير جميع العمليات الحالية."})]})]}),e.jsx("button",{onClick:V,disabled:U,className:"w-full bg-rose-600 text-white py-5 rounded-2xl font-bold text-xl shadow-lg hover:bg-rose-700 transition-all active:scale-95 flex items-center justify-center gap-4 disabled:opacity-50 disabled:cursor-not-allowed",children:U?e.jsxs(e.Fragment,{children:[e.jsx(Q,{size:24,className:"animate-spin"})," جاري تنفيذ الإقفال والترحيل..."]}):e.jsxs(e.Fragment,{children:["تنفيذ الإقفال النهائي والترحيل ",e.jsx(Y,{size:24})]})})]})]}),P===3&&e.jsxs("div",{className:"p-20 text-center space-y-8 animate-in zoom-in duration-500",children:[e.jsx("div",{className:"w-32 h-32 bg-indigo-50 rounded-full flex items-center justify-center mx-auto border-2 border-indigo-100",children:e.jsx(Y,{size:64,className:"text-indigo-600"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-4xl font-bold text-slate-900",children:"تم الإقفال بنجاح!"}),e.jsx("p",{className:"text-indigo-600 font-bold text-lg uppercase tracking-widest",children:"أهلاً بك في السنة المالية الجديدة"})]}),e.jsx("p",{className:"text-slate-500 max-w-md mx-auto leading-relaxed",children:"تم ترحيل جميع الأرصدة بنجاح وتصفير سجل العمليات. يمكنك الآن البدء في تسجيل معاملات السنة الجديدة."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"bg-slate-900 text-indigo-400 px-12 py-5 rounded-2xl font-bold text-lg shadow-lg hover:bg-indigo-500 hover:text-slate-900 transition-all active:scale-95",children:"بدء العمل الآن"})]}),e.jsxs("div",{className:"bg-slate-50 p-6 flex justify-between items-center border-t border-slate-100",children:[e.jsxs("div",{className:"flex gap-6",children:[e.jsx(R,{icon:e.jsx(q,{size:12}),label:"الخزائن",count:d.length}),e.jsx(R,{icon:e.jsx($,{size:12}),label:"العملاء",count:r.length}),e.jsx(R,{icon:e.jsx(G,{size:12}),label:"الموردين",count:o.length}),e.jsx(R,{icon:e.jsx($,{size:12}),label:"الموظفين",count:(h||[]).length}),e.jsx(R,{icon:e.jsx($,{size:12}),label:"الشركاء",count:(m||[]).length})]}),e.jsxs("div",{className:"text-[9px] font-bold text-slate-400 uppercase tracking-widest",children:["المحاسب: ",w.accountantName]})]})]})})},p=({label:r,value:o,color:d})=>e.jsxs("div",{className:"bg-slate-50 p-5 rounded-2xl border border-slate-100",children:[e.jsx("p",{className:"text-[9px] font-bold text-slate-400 uppercase tracking-wider mb-1",children:r}),e.jsxs("p",{className:`text-xl font-bold ${d}`,children:[o," ",e.jsx("span",{className:"text-[10px] opacity-40",children:"ج.م"})]})]}),R=({icon:r,label:o,count:d})=>e.jsxs("div",{className:"flex items-center gap-2 text-[10px] font-bold text-slate-400 uppercase",children:[r," ",o,": ",e.jsx("span",{className:"text-slate-900",children:d})]});export{te as default};
